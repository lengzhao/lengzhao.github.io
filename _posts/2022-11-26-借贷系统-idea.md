---
layout: post
tags: blockchain DeFi 想法
subtitle: 一个基于订单簿的借贷系统的想法
mermaid: true
---

# 基于订单簿的借贷系统

## 目标

1. 不限制代币，没有白名单；支持大量的长尾资产代币(也可以支持NFT)
2. 没有价格波动的清算，只有到期清算
3. 利息固定，借款双方更方便计算收益

## 流程

1. 出借人：借出token的人，可以获得利息收益
   1. 只需要链下签名，一般情况下，无需直接与合约交互，挂单无需手续费
2. 借款人：想要借token的人，需要抵押指定的资产，到期需要还款并支付利息

```mermaid
sequenceDiagram
participant a as 出借人
participant b as 借款人
participant c as 平台（前段/数据库）
participant d as 智能合约
loop 下单
    a ->> c: 下单：出借的代币/金额/利率/时间/签名
    c ->> c: 存储到数据库
end
loop 借款
    b ->> c: 浏览/查询
    c -->> b: 
    b ->> d: 借款，信息上链
    d ->> d: 确认订单ID未使用
    d ->> d: 标记订单ID
    d ->> d: 确认借款时间
    d ->> d: 验证签名
    d ->> d: 创建借款单
    d ->> b: 转移资产(抵押物)
    b -->> d: 
    d ->> a: 转移资产(出借的代币)
    a ->> b: 代币
end
loop 还款
    b ->> d: 还款
    d ->> d: 删除借款单
    d ->> b: 转移代币（借款的代币）
    b ->> a: 转移代币
    a ->> a: 代币和对应利息
    d ->> b: 解锁抵押物
    b ->> b: 取回抵押物
end
loop 清算
    a ->> d: 清算
    d ->> d: 借款已经超时
    d ->> d: 删除借款单
    d ->> a: 抵押物转给出借人
    a ->> a: 损失代币，得到抵押物
end
```

## 角色

### 出借人

1. 可以自己指定要借出的token
2. 需要approve给撮合合约
3. 同一份资产，允许多次挂单，不同的数量、利息、到期事件等
4. 出借人只需要挂单并签名，挂单是放到平台的数据库里的
5. 默认出借人不需要支付任何手续费。
6. Token参数：
   1. id
   2. 代币类型：合约地址
   3. 数量
   4. 利息代币类型：序号
      1. 借出的代币
      2. 抵押的代币
      3. eth
      4. dai
      5. usdt
   5. 年利息：数量
   6. 时间：最短时间，最长时间
   7. 抵押物资产类型和数量
      1. 默认是WETH
      2. 可以指定其他类型代币
      3. 可以是NFT
   8. 限定借款人：地址为空表示不限制
7. NFT参数：
   1. id
   2. NFT类型
   3. 利息代币类型：序号
      1. 抵押的代币
      2. eth
      3. dai
      4. usdt
   4. 年利息：数量
   5. 时间：最短时间，最长时间
   6. 抵押物资产类型和数量
   7. 限定借款人
8. 出借人可以是合约
   1. 合约实现特定的接口，用于校验挂单的合法性（代替签名校验）
   2. 返回订单id

### 借款人

1. 从平台上，选择想要借的资产，数量
2. 参数：
   1. id
   2. 选择要借贷的时间
      1. 大于最小时间
      2. 小于最大时间
      3. 小于1年
   3. 要使用的存储空间id
      1. 空间复用，节省成本
3. 将出借人的挂单和自己选项提交上链，通过合约完成撮合

### 智能合约

1. 撮合双方的交易
2. 代持抵押物
3. 记录挂单完成状态
4. 偿还流程处理
5. 超时清算处理
6. 一键卖出（做空）

### 平台（链下部分）

1. 展示：显示所有的挂单
2. 查询：可以根据需要，选择/过滤自己需要的挂单
3. 存储服务：存储用户提交的挂单

## 模式

1. maker
   1. 由出借人挂单，借款人上链
2. taker
   1. 由借款人提出需求，出借人同意并上链

## 扩展

1. 以合约的方式，提供借贷池
2. 用户只需要将资金放入借贷池，所有人平分收益
3. 借款人通过借贷池创建一个虚拟挂单
